name: AIB Create Image
# Manually run the workflow
on: workflow_dispatch
# Automatically run the workflow after a push
#on: push

env:
  AIB_IMAGE_VERSION: 0.1.${{GITHUB.RUN_ID}}

jobs:
  build:
    name: Azure Image Builder
    runs-on: windows-latest
    steps:
    ## Checkout your GitHub Workspace
    - name: Checkout
      uses: actions/checkout@v1
    
    # Authentication: log on to Azure with the AZURE_CREDENTIALS secret
    - name: Login via Az module
      uses: azure/login@v1
      with:
        creds: ${{secrets.AZURE_CREDENTIALS}}
        enable-AzPSSession: true 
    
    # Run an image builder action (https://github.com/lnochili/azure-actions-imagebuilder/blob/master/action.yaml)    
    - name: Create AIB VM Image
      id: imageBuilder
      uses: azure/build-vm-image@v0
      with:
        location: 'westeurope'
        resource-group-name: 'rg-wvd-images'
        managed-identity: ${{secrets.AZURE_AIB_IDENTITY}}
        source-os-type: 'windows'
        source-image-type: 'platformImage'
        source-image: 'MicrosoftWindowsDesktop:Windows-10:19h2-evd:latest'
        customizer-source: '${{GITHUB.WORKSPACE}}\AIBCustomizations'
        customizer-script: |
          & 'C:\AIBCustomizations\Customize-WVDImage.ps1'
        dist-type: 'SharedImageGallery'
        dist-resource-id: '/subscriptions/${{secrets.AZURE_SUBSCRIPTIONID}}/resourceGroups/rg-wvd-images/providers/Microsoft.Compute/galleries/sigWVDImages/images/Win10-MU-ImgDef/versions/${{env.AIB_IMAGE_VERSION}}'
        dist-location: 'westeurope'

